openapi: '3.0.3'
info:
  title: CHEFOS2 API
  description: API documentation for CHEFOS2 - Restaurant Management System
  version: '1.0.0'
  contact:
    name: CHEFOS2 Team
  license:
    name: MIT

servers:
  - url: https://api.server.test/v1
    description: Development Server
  - url: https://api.production.test/v1
    description: Production Server

tags:
  - name: Authentication
    description: Authentication endpoints
  - name: Ingredients
    description: Ingredient management
  - name: Suppliers
    description: Supplier management
  - name: Purchase Orders
    description: Purchase order management
  - name: Events
    description: Event management
  - name: Recipes
    description: Recipe management
  - name: Kitchen
    description: Kitchen operations
  - name: Delivery Notes
    description: OCR delivery notes and imports
  - name: Inventory
    description: Batches, expiries, stock-out, locations
  - name: Staff
    description: Kitchen staff profiles and contracts
  - name: Time Off
    description: Staff time off requests and approvals
  - name: Schedules
    description: Monthly schedules and shifts
  - name: Preparations
    description: Preparations catalog and batches
  - name: Schedule Rules
    description: Staff and organization schedule rules

paths:
  /health:
    get:
      summary: Health check
      tags:
        - System
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /auth/login:
    post:
      summary: User login
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials

  /auth/logout:
    post:
      summary: User logout
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
        '401':
          description: Unauthorized

  /delivery-notes:
    get:
      summary: List delivery notes with items
      tags:
        - Delivery Notes
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Delivery notes list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/DeliveryNote'

  /delivery-notes/{id}:
    get:
      summary: Get delivery note by id
      tags:
        - Delivery Notes
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Delivery note detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/DeliveryNote'

  /delivery-notes/items/{id}:
    patch:
      summary: Update delivery note item
      tags:
        - Delivery Notes
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeliveryNoteItemUpdate'
      responses:
        '200':
          description: Updated item

  /delivery-notes/{id}/import-to-inventory:
    post:
      summary: Import delivery note items to inventory batches
      tags:
        - Delivery Notes
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                item_updates:
                  type: array
                  items:
                    $ref: '#/components/schemas/DeliveryNoteItemUpdate'
      responses:
        '200':
          description: Import result

  /inventory/batches:
    get:
      summary: List inventory batches
      tags:
        - Inventory
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: ingredient_id
          schema:
            type: string
        - in: query
          name: expiring_in_days
          schema:
            type: integer
        - in: query
          name: location_id
          schema:
            type: string
      responses:
        '200':
          description: Batches list

  /inventory/batches/{id}:
    patch:
      summary: Update batch expiry/location/lot
      tags:
        - Inventory
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                expiry_date:
                  type: string
                  format: date
                storage_location_id:
                  type: string
                lot_code:
                  type: string
      responses:
        '200':
          description: Batch updated

  /inventory/batches/{id}/expiry/scan:
    post:
      summary: Scan expiry date from image
      tags:
        - Inventory
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Expiry candidates

  /inventory/stock-out:
    post:
      summary: Stock out with FEFO by barcode or ingredient
      tags:
        - Inventory
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - quantity
              properties:
                barcode:
                  type: string
                ingredient_id:
                  type: string
                quantity:
                  type: number
                movement_type:
                  type: string
                  enum: [OUT, WASTE, ADJUSTMENT]
                production_order_id:
                  type: string
                notes:
                  type: string
                save_barcode:
                  type: boolean
      responses:
        '200':
          description: Stock out result

  /inventory/locations:
    get:
      summary: List storage locations
      tags:
        - Inventory
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Locations list
    post:
      summary: Create storage location
      tags:
        - Inventory
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                type:
                  type: string
      responses:
        '201':
          description: Location created

  /inventory/locations/{id}:
    patch:
      summary: Update storage location
      tags:
        - Inventory
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                type:
                  type: string
      responses:
        '200':
          description: Location updated
    delete:
      summary: Delete storage location
      tags:
        - Inventory
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Location deleted

  /staff:
    get:
      summary: List staff profiles
      tags:
        - Staff
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Staff list
    post:
      summary: Create staff profile
      tags:
        - Staff
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - member_id
              properties:
                member_id:
                  type: string
                role_in_kitchen:
                  type: string
                skills:
                  type: array
                  items:
                    type: string
                active:
                  type: boolean
                contract:
                  type: object
                  properties:
                    weekly_hours_target:
                      type: number
                    max_weekly_hours:
                      type: number
                    vacation_days_per_year:
                      type: integer
                    rest_min_hours_between_shifts:
                      type: integer
      responses:
        '201':
          description: Staff created

  /staff/{id}:
    patch:
      summary: Update staff profile
      tags:
        - Staff
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role_in_kitchen:
                  type: string
                skills:
                  type: array
                  items:
                    type: string
                active:
                  type: boolean
                contract:
                  type: object
                  properties:
                    weekly_hours_target:
                      type: number
                    max_weekly_hours:
                      type: number
                    vacation_days_per_year:
                      type: integer
                    rest_min_hours_between_shifts:
                      type: integer
      responses:
        '200':
          description: Staff updated

  /staff/{id}/vacation-balance:
    get:
      summary: Get staff vacation balance
      tags:
        - Staff
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: query
          name: year
          schema:
            type: integer
      responses:
        '200':
          description: Vacation balance

  /time-off:
    get:
      summary: List time off requests
      tags:
        - Time Off
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
      responses:
        '200':
          description: Time off list
    post:
      summary: Request time off
      tags:
        - Time Off
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - staff_id
                - type
                - start_date
                - end_date
              properties:
                staff_id:
                  type: string
                type:
                  type: string
                  enum: [VACATION, SICK_LEAVE, OTHER]
                start_date:
                  type: string
                  format: date
                end_date:
                  type: string
                  format: date
                notes:
                  type: string
      responses:
        '201':
          description: Time off requested

  /time-off/{id}/approve:
    patch:
      summary: Approve time off
      tags:
        - Time Off
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                policy:
                  type: string
                  enum: [CALENDAR, BUSINESS]
      responses:
        '200':
          description: Time off approved

  /time-off/{id}/reject:
    patch:
      summary: Reject time off
      tags:
        - Time Off
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Time off rejected

  /schedules/months:
    post:
      summary: Create schedule month
      tags:
        - Schedules
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - month
              properties:
                month:
                  type: string
                  example: 2026-01
      responses:
        '201':
          description: Schedule month created

  /schedules/months/{id}:
    get:
      summary: Get schedule month
      tags:
        - Schedules
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Schedule month detail

  /schedules/months/{id}/validate:
    post:
      summary: Validate schedule month rules
      tags:
        - Schedules
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Validation result

  /schedules/months/{id}/publish:
    post:
      summary: Publish schedule month
      tags:
        - Schedules
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Schedule month published

  /schedules/shifts:
    post:
      summary: Create shift
      tags:
        - Schedules
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - schedule_month_id
                - date
                - start_time
                - end_time
                - shift_code
              properties:
                schedule_month_id:
                  type: string
                date:
                  type: string
                  format: date
                start_time:
                  type: string
                end_time:
                  type: string
                shift_code:
                  type: string
                station:
                  type: string
      responses:
        '201':
          description: Shift created

  /schedules/shifts/{id}:
    patch:
      summary: Update shift
      tags:
        - Schedules
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                date:
                  type: string
                  format: date
                start_time:
                  type: string
                end_time:
                  type: string
                shift_code:
                  type: string
                station:
                  type: string
      responses:
        '200':
          description: Shift updated

  /schedules/shifts/{id}/assignments:
    patch:
      summary: Update shift assignments
      tags:
        - Schedules
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                staff_ids:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Assignments updated

  /preparations:
    get:
      summary: List preparations
      tags:
        - Preparations
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Preparations list
    post:
      summary: Create preparation
      tags:
        - Preparations
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - unit_id
              properties:
                name:
                  type: string
                unit_id:
                  type: string
                default_shelf_life_days:
                  type: integer
                station:
                  type: string
                notes:
                  type: string
                active:
                  type: boolean
      responses:
        '201':
          description: Preparation created

  /preparations/{id}:
    patch:
      summary: Update preparation
      tags:
        - Preparations
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                unit_id:
                  type: string
                default_shelf_life_days:
                  type: integer
                station:
                  type: string
                notes:
                  type: string
                active:
                  type: boolean
      responses:
        '200':
          description: Preparation updated

  /preparations/{id}/batches:
    post:
      summary: Create preparation batch
      tags:
        - Preparations
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - produced_at
                - quantity_produced
              properties:
                produced_at:
                  type: string
                  format: date
                quantity_produced:
                  type: number
                expiry_date:
                  type: string
                  format: date
                lot_code:
                  type: string
                storage_location_id:
                  type: string
                ingredients:
                  type: array
                  items:
                    type: object
                    properties:
                      ingredient_id:
                        type: string
                      unit_id:
                        type: string
                      quantity_used:
                        type: number
      responses:
        '201':
          description: Preparation batch created

  /preparations/batches:
    get:
      summary: List preparation batches
      tags:
        - Preparations
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: expiring_in_days
          schema:
            type: integer
        - in: query
          name: location_id
          schema:
            type: string
      responses:
        '200':
          description: Preparation batches list

  /preparations/batches/{id}:
    patch:
      summary: Update preparation batch
      tags:
        - Preparations
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                expiry_date:
                  type: string
                  format: date
                storage_location_id:
                  type: string
                quantity_current:
                  type: number
                lot_code:
                  type: string
      responses:
        '200':
          description: Preparation batch updated

  /preparations/batches/{id}/labels/print:
    post:
      summary: Print preparation batch labels
      tags:
        - Preparations
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                label_count:
                  type: integer
      responses:
        '200':
          description: PDF labels

  /preparations/batches/{id}/expiry/scan:
    post:
      summary: Scan expiry date for preparation batch
      tags:
        - Preparations
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Expiry candidates

  /schedule-rules/staff/{staffId}:
    get:
      summary: Get staff schedule rules
      tags:
        - Schedule Rules
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: staffId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Staff rules
    patch:
      summary: Update staff schedule rules
      tags:
        - Schedule Rules
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: staffId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                allowed_shift_codes:
                  type: array
                  items:
                    type: string
                rotation_mode:
                  type: string
                preferred_days_off:
                  type: array
                  items:
                    type: string
                max_consecutive_days:
                  type: integer
                requires_weekend_off_per_month:
                  type: boolean
      responses:
        '200':
          description: Staff rules updated

  /schedule-rules/org:
    get:
      summary: Get organization schedule rules
      tags:
        - Schedule Rules
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Organization rules
    patch:
      summary: Update organization schedule rules
      tags:
        - Schedule Rules
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                weekend_definition:
                  type: string
                enforce_weekend_off_hard:
                  type: boolean
                rotation_enabled:
                  type: boolean
      responses:
        '200':
          description: Organization rules updated

components:
  schemas:
    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT authentication token
        user:
          type: object
          properties:
            id:
              type: string
            email:
              type: string
            name:
              type: string

    DeliveryNoteItem:
      type: object
      properties:
        id:
          type: string
        description:
          type: string
        quantity:
          type: number
        unit_price:
          type: number
        ingredient_id:
          type: string
          nullable: true
        unit_id:
          type: string
          nullable: true
        status:
          type: string
        lot_code:
          type: string
          nullable: true
        expiry_date:
          type: string
          format: date
          nullable: true
        storage_location_id:
          type: string
          nullable: true

    DeliveryNote:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
        total_amount:
          type: number
        image_url:
          type: string
        created_at:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: '#/components/schemas/DeliveryNoteItem'

    DeliveryNoteItemUpdate:
      type: object
      properties:
        ingredient_id:
          type: string
          nullable: true
        unit_id:
          type: string
          nullable: true
        status:
          type: string
        quantity:
          type: number
        unit_price:
          type: number
        lot_code:
          type: string
          nullable: true
        expiry_date:
          type: string
          format: date
          nullable: true
        storage_location_id:
          type: string
          nullable: true

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
